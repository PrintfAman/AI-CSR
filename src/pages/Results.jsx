import React, { useState } from "react";
import { useLocation, useNavigate } from "react-router-dom";
import { motion } from "framer-motion";
import { GiArtificialHive } from "react-icons/gi";
import { FaShare, FaCopy, FaCheck } from "react-icons/fa";

function Results() {
  const location = useLocation();
  const navigate = useNavigate();
  const { results } = location.state || {};
  const [copied, setCopied] = useState(false);

  console.log("ðŸ“Š Results received:", results);

  // âœ… Get track map image
  const getTrackMap = (trackName) => {
    const trackMaps = {
      "monaco": "ðŸ‡²ðŸ‡¨",
      "monza": "ðŸ‡®ðŸ‡¹",
      "silverstone": "ðŸ‡¬ðŸ‡§",
      "spa": "ðŸ‡§ðŸ‡ª",
      "suzuka": "ðŸ‡¯ðŸ‡µ",
      "singapore": "ðŸ‡¸ðŸ‡¬",
      "baku": "ðŸ‡¦ðŸ‡¿",
      "canada": "ðŸ‡¨ðŸ‡¦",
      "bahrain": "ðŸ‡§ðŸ‡­",
      "miami": "ðŸ‡ºðŸ‡¸",
      "las vegas": "ðŸ‡ºðŸ‡¸",
      "qatar": "ðŸ‡¶ðŸ‡¦",
      "abu dhabi": "ðŸ‡¦ðŸ‡ª",
    };

    const track = trackName.toLowerCase();
    for (let key in trackMaps) {
      if (track.includes(key)) {
        return trackMaps[key];
      }
    }
    return "ðŸ";
  };

  // âœ… Handle Share Setup
  const handleShare = () => {
    const setupData = {
      track: results.trackName,
      weather: results.weather,
      downforce: results.setupDetails.downforce,
      suspension: results.setupDetails.suspension,
      tirePressure: results.setupDetails.tirePressure,
      brakeBias: results.setupDetails.brakeBias,
    };

    const setupText = `ðŸŽï¸ F1 Setup for ${results.trackName}\n\n` +
      `ðŸŒ¤ï¸ Weather: ${results.weather}\n` +
      `âœˆï¸ Downforce: ${setupData.downforce}\n` +
      `âš™ï¸ Suspension: ${setupData.suspension}\n` +
      `ðŸ›ž Tire Pressure: ${setupData.tirePressure}\n` +
      `ðŸ”´ Brake Bias: ${setupData.brakeBias}\n\n` +
      `Generated by AI F1 Setup Recommender`;

    // Copy to clipboard
    navigator.clipboard.writeText(setupText).then(() => {
      setCopied(true);
      setTimeout(() => setCopied(false), 2000);
    });
  };

  // âœ… Handle AI Analysis Navigation
  const handleViewAIAnalysis = () => {
    if (!results?.trackName || !results?.weather) {
      alert("Missing track or weather information!");
      return;
    }

    console.log("ðŸ¤– Navigating to AI Analysis from Results");

    localStorage.setItem("aiRecommenderVisible", "true");

    navigate("/aiexplanation", {
      state: {
        trackName: results.trackName,
        weather: results.weather
      },
    });
  };

  // If no results, redirect back to home
  if (!results) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center">
          <h2 className="text-2xl font-azonix text-red-500 mb-4">No Results Found</h2>
          <button
            onClick={() => navigate("/")}
            className="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold"
          >
            Back to Home
          </button>
        </div>
      </div>
    );
  }

  const { trackName, weather, explanation, recommendations, setupDetails } = results;

  console.log("ðŸ”§ Setup Details:", setupDetails);
  console.log("ðŸ“ Recommendations:", recommendations);

  // All your existing helper functions...
  const getTrackType = (track) => {
    const streetCircuits = ["monaco", "singapore", "baku", "azerbaijan", "jeddah", "saudi arabia", "miami", "las vegas"];
    return streetCircuits.some(st => track.toLowerCase().includes(st)) ? "street" : "permanent";
  };

  const getAvgSpeed = (track) => {
    const speeds = {
      "monaco": "160 km/h",
      "monza": "264 km/h",
      "italy": "264 km/h",
      "silverstone": "240 km/h",
      "great britain": "240 km/h",
      "spa": "237 km/h",
      "belgium": "237 km/h",
      "suzuka": "225 km/h",
      "japan": "225 km/h",
      "singapore": "172 km/h",
      "bahrain": "205 km/h",
      "default": "215 km/h"
    };
    return speeds[track.toLowerCase()] || speeds.default;
  };

  const getCornerCount = (track) => {
    const corners = {
      "monaco": "19",
      "singapore": "23",
      "suzuka": "18",
      "japan": "18",
      "spa": "19",
      "belgium": "19",
      "silverstone": "18",
      "great britain": "18",
      "default": "16"
    };
    return corners[track.toLowerCase()] || corners.default;
  };

  const getDownforceLevel = (downforce) => {
    const levels = {
      "Very Low": "15%",
      "Low": "35%",
      "Medium-Low": "45%",
      "Medium": "55%",
      "Medium-High": "70%",
      "High": "85%",
      "Very High": "95%",
      "Maximum": "100%"
    };
    return levels[downforce] || "55%";
  };

  const getSuspensionLevel = (suspension) => {
    const levels = {
      "Very Soft": "25%",
      "Soft": "35%",
      "Medium-Soft": "45%",
      "Medium": "55%",
      "Medium-Stiff": "65%",
      "Stiff": "80%",
      "Very Stiff": "95%"
    };
    return levels[suspension] || "55%";
  };

  const trackType = getTrackType(trackName);
  const avgSpeed = getAvgSpeed(trackName);
  const cornerCount = getCornerCount(trackName);
  const downforcePercent = getDownforceLevel(setupDetails.downforce);
  const suspensionPercent = getSuspensionLevel(setupDetails.suspension);

  const rideHeight = trackType === "street" ? "32/40 mm" : "25/35 mm";
  const aeroBalance = parseInt(downforcePercent) > 70 ? "58%" : parseInt(downforcePercent) > 50 ? "54%" : "50%";
  const differential = trackType === "street" ? "60/50%" : "55/48%";
  const gearRatios = avgSpeed.includes("264") || avgSpeed.includes("237") ? "long" :
    avgSpeed.includes("160") || avgSpeed.includes("172") ? "short" : "medium";
  const tireCompound = trackType === "street" ? "soft" : "medium";
  const tireWear = trackName.toLowerCase().includes("qatar") || trackName.toLowerCase().includes("bahrain") ? "high" :
    trackName.toLowerCase().includes("monaco") || trackName.toLowerCase().includes("singapore") ? "medium" : "medium-high";
  const fuelConsumption = avgSpeed.includes("264") || avgSpeed.includes("237") ? "high" :
    avgSpeed.includes("160") || avgSpeed.includes("172") ? "low" : "medium";
  const ersStrategy = avgSpeed.includes("264") ? "overtake" : trackType === "street" ? "balanced" : "balanced";
  const overtakingDifficulty = trackName.toLowerCase().includes("monaco") || trackName.toLowerCase().includes("singapore") ? "very hard" :
    trackType === "street" ? "hard" : "medium";
  const drsZones = trackName.toLowerCase().includes("monaco") ? "1" :
    trackName.toLowerCase().includes("singapore") ? "2" :
      trackName.toLowerCase().includes("baku") ? "2" : "2-3";

  return (
    <div className="h-screen w-full flex items-center justify-center bg-black/90 overflow-hidden">

      




      <motion.div
        initial={{ opacity: 0, scale: 0.95 }}
        animate={{ opacity: 1, scale: 1 }}
        transition={{ duration: 0.5 }}
        className="w-full max-w-5xl h-[90vh] overflow-y-auto scrollbar-thin scrollbar-thumb-red-700 scrollbar-track-transparent bg-gradient-to-br from-black/70 via-red-950/20 to-black/70 backdrop-blur-xl border-2 border-red-900/60 rounded-3xl p-6 sm:p-8 shadow-2xl mx-auto"
      >

        


        {/* Header with Track Flag */}
        <div className="text-center mb-8">
          <div className="text-6xl mb-3">{getTrackMap(trackName)}</div>
          <h1 className="text-3xl font-azonix text-white mb-2 tracking-widest">
            RECOMMENDED SETUP
          </h1>
          <div className="h-1 w-32 bg-red-600 mx-auto"></div>
        </div>

        {/* Share Button */}
        <div className="flex justify-end mb-4">
          <motion.button
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
            onClick={handleShare}
          className="flex items-center gap-2 bg-gradient-to-r from-red-700 via-red-800 to-black
           hover:from-red-800 hover:via-black hover:to-black text-white 
           px-5 py-2.5 rounded-lg font-bold tracking-wide transition-all
           duration-300 shadow-[0_0_15px_rgba(255,0,0,0.3)] hover:shadow-[0_0_25px_rgba(255,0,0,0.6)]">

            {copied ? (
              <>
                <FaCheck className="text-lg" />
                Copied!
              </>
            ) : (
              <>
                <FaShare className="text-lg" />
                Share Setup
              </>
            )}
          </motion.button>
        </div>

        {/* Main Grid - 3 Columns */}
        <div className="grid grid-cols-3 gap-x-8 gap-y-3 mb-8">
          {/* Column 1 */}
          <div className="space-y-3">
            <div>
              <p className="text-gray-400 text-sm mb-1">Track</p>
              <p className="text-white text-xl font-bold">{trackName || "Unknown"}</p>
            </div>

            <div>
              <p className="text-gray-400 text-sm mb-1">Avg Speed</p>
              <p className="text-white text-xl font-bold">{avgSpeed || "N/A"}</p>
            </div>

            <div>
              <p className="text-gray-400 text-sm mb-1">Suspension</p>
              <p className="text-white text-xl font-bold">{suspensionPercent || setupDetails?.suspension || "N/A"}</p>
            </div>

            <div>
              <p className="text-gray-400 text-sm mb-1">Tire Pressure (F/R)</p>
              <p className="text-white text-xl font-bold">{setupDetails?.tirePressure || "N/A"}</p>
            </div>

            <div>
              <p className="text-gray-400 text-sm mb-1">Gear Ratios</p>
              <p className="text-white text-xl font-bold">{gearRatios || "N/A"}</p>
            </div>

            <div>
              <p className="text-gray-400 text-sm mb-1">Tire Wear</p>
              <p className="text-white text-xl font-bold">{tireWear || "N/A"}</p>
            </div>

            <div>
              <p className="text-gray-400 text-sm mb-1">DRS Zones</p>
              <p className="text-white text-xl font-bold">{drsZones || "N/A"}</p>
            </div>
          </div>

          {/* Column 2 */}
          <div className="space-y-3">
            <div>
              <p className="text-gray-400 text-sm mb-1">Weather</p>
              <p className="text-white text-xl font-bold">{weather || "Unknown"}</p>
            </div>

            <div>
              <p className="text-gray-400 text-sm mb-1">Corner Count</p>
              <p className="text-white text-xl font-bold">{cornerCount || "N/A"}</p>
            </div>

            <div>
              <p className="text-gray-400 text-sm mb-1">Aero Balance</p>
              <p className="text-white text-xl font-bold">{aeroBalance || "N/A"}</p>
            </div>

            <div>
              <p className="text-gray-400 text-sm mb-1">Brake Bias</p>
              <p className="text-white text-xl font-bold">{setupDetails?.brakeBias || "N/A"}</p>
            </div>

            <div>
              <p className="text-gray-400 text-sm mb-1">Tire Compound</p>
              <p className="text-white text-xl font-bold">{tireCompound || "N/A"}</p>
            </div>

            <div>
              <p className="text-gray-400 text-sm mb-1">ERS Strategy</p>
              <p className="text-white text-xl font-bold">{ersStrategy || "N/A"}</p>
            </div>
          </div>

          {/* Column 3 */}
          <div className="space-y-3">
            <div>
              <p className="text-gray-400 text-sm mb-1">Track Type</p>
              <p className="text-white text-xl font-bold">{trackType || "N/A"}</p>
            </div>

            <div>
              <p className="text-gray-400 text-sm mb-1">Downforce</p>
              <p className="text-white text-xl font-bold">{downforcePercent || setupDetails?.downforce || "N/A"}</p>
            </div>

            <div>
              <p className="text-gray-400 text-sm mb-1">Ride Height (F/R)</p>
              <p className="text-white text-xl font-bold">{rideHeight || "N/A"}</p>
            </div>

            <div>
              <p className="text-gray-400 text-sm mb-1">Diff (On/Off)</p>
              <p className="text-white text-xl font-bold">{differential || "N/A"}</p>
            </div>

            <div>
              <p className="text-gray-400 text-sm mb-1">Fuel Consumption</p>
              <p className="text-white text-xl font-bold">{fuelConsumption || "N/A"}</p>
            </div>

            <div>
              <p className="text-gray-400 text-sm mb-1">Overtake Difficulty</p>
              <p className="text-white text-xl font-bold">{overtakingDifficulty || "N/A"}</p>
            </div>
          </div>
        </div>

        {/* Divider */}
        <div className="h-px bg-gradient-to-r from-transparent via-red-800 to-transparent my-8"></div>

        {/* Notes Section */}
        <div className="mb-2">
          <p className="text-gray-400 text-sm mb-3">Notes</p>
          <p className="text-white/90 text-base leading-relaxed">
            {explanation}
          </p>
        </div>

        {/* VIEW AI ANALYSIS BUTTON */}
        <motion.button
          whileHover={{ scale: 1.02 }}
          whileTap={{ scale: 0.98 }}
          onClick={handleViewAIAnalysis}
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.3 }}
          className="w-full bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-bold py-4 rounded-xl text-lg transition-all shadow-lg shadow-red-900/50 flex items-center justify-center gap-3 mb-4"
        >
          <GiArtificialHive className="text-2xl" />
          VIEW AI ANALYSIS
        </motion.button>

        {/* Back Button */}
        <motion.button
          whileHover={{ scale: 1.02 }}
          whileTap={{ scale: 0.98 }}
          onClick={() => navigate("/")}
          className="w-full bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-800 hover:to-gray-900 text-white font-bold py-4 rounded-xl text-lg transition-all shadow-lg"
        >
          Back to Home
        </motion.button>
      </motion.div>
    </div>
  );
}

export default Results;